<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声キーワード検出テスト</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        
        .status-active { background-color: #4CAF50; }
        .status-inactive { background-color: #f44336; }
        .status-listening { background-color: #2196F3; animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .button:hover {
            transform: translateY(-2px);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .keyword-detected {
            background: rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .instructions {
            background: rgba(255, 193, 7, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 音声キーワード検出テスト</h1>
        
        <div class="instructions">
            <strong>使用方法:</strong><br>
            1. 「開始」ボタンを押してマイクアクセスを許可<br>
            2. 「ねえ マックス」と話す<br>
            3. キーワードが検出されると反応します
        </div>
        
        <div class="status-card">
            <span class="status-indicator" id="micStatus"></span>
            <span id="micStatusText">マイク: 未初期化</span>
        </div>
        
        <div class="status-card">
            <span class="status-indicator" id="listeningStatus"></span>
            <span id="listeningStatusText">音声認識: 停止中</span>
        </div>
        
        <div class="button-container">
            <button class="button" id="startBtn" onclick="startListening()">🎤 開始</button>
            <button class="button" id="stopBtn" onclick="stopListening()" disabled>⏹️ 停止</button>
            <button class="button" onclick="clearLog()">🗑️ ログクリア</button>
        </div>
        
        <div id="keywordAlert" class="keyword-detected" style="display: none;">
            🎉 キーワードが検出されました！
        </div>
        
        <div class="log" id="log">
            <div>ログが表示されます...</div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isListening = false;
        
        // キーワードリスト
        const keywords = [
            // 日本語のみ（スペースバリエーション）
            'ねえ マックス', 'ねえ　マックス', 'ねえマックス',
            'ねぇ マックス', 'ねぇ　マックス', 'ねぇマックス',
            'ネエ マックス', 'ネエ　マックス', 'ネエマックス',
            'ネェ マックス', 'ネェ　マックス', 'ネェマックス',
            // 英語のみ（スペースバリエーション）
            'hey max', 'hey　max', 'heymax',
            'Hey Max', 'Hey　Max', 'HeyMax',
            'HEY MAX', 'HEY　MAX', 'HEYMAX',
            // 日本語と英語の組み合わせ（スペースバリエーション）
            'Hey マックス', 'Hey　マックス', 'Heyマックス',
            'HEY マックス', 'HEY　マックス', 'HEYマックス',
            'hey マックス', 'hey　マックス', 'heyマックス',
            'ねえ Max', 'ねえ　Max', 'ねえMax',
            'ねぇ Max', 'ねぇ　Max', 'ねぇMax',
            // 全角英数字（スペースバリエーション）
            'Ｈｅｙ　Ｍａｘ', 'Ｈｅｙ Ｍａｘ', 'ＨｅｙＭａｘ',
            'Ｈｅｙ　ｍａｘ', 'Ｈｅｙ ｍａｘ', 'Ｈｅｙｍａｘ',
            // 区切り文字バリエーション
            'ねえ・マックス', 'ねぇ・マックス', 'Hey-Max', 'Hey_Max',
            'ねえ・マックス', 'Hey・Max', 'Hey・max',
            'ねえ-マックス', 'ねぇ-マックス', 'Hey-マックス', 'hey-マックス',
            'ねえ_マックス', 'ねぇ_マックス', 'Hey_マックス', 'hey_マックス',
            // その他のバリエーション
            'ねーマックス', 'ねー　マックス', 'ねーマックス', 'ねー マックス', 
            'ねぇーマックス', 'ねぇー　マックス', 'ねぇーマックス',
            'ネエーマックス', 'ネエー　マックス', 'ネエーマックス',
            'ネェーマックス', 'ネェー　マックス', 'ネェーマックス',
            'ネーマックス', 'ネー　マックス', 'ネーマックス',
            'ネェーマックス', 'ネェー　マックス', 'ネェーマックス',
            'ねマックス', 'ね　マックス', 'ね マックス',
            'ネマックス', 'ネ　マックス', 'ネ マックス',
        ];
        
        function updateStatus(micActive, listening) {
            const micStatus = document.getElementById('micStatus');
            const micStatusText = document.getElementById('micStatusText');
            const listeningStatus = document.getElementById('listeningStatus');
            const listeningStatusText = document.getElementById('listeningStatusText');
            
            if (micActive) {
                micStatus.className = 'status-indicator status-active';
                micStatusText.textContent = 'マイク: アクティブ';
            } else {
                micStatus.className = 'status-indicator status-inactive';
                micStatusText.textContent = 'マイク: 非アクティブ';
            }
            
            if (listening) {
                listeningStatus.className = 'status-indicator status-listening';
                listeningStatusText.textContent = '音声認識: リスニング中...';
            } else {
                listeningStatus.className = 'status-indicator status-inactive';
                listeningStatusText.textContent = '音声認識: 停止中';
            }
        }
        
        function addLog(message) {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function showKeywordAlert() {
            const alert = document.getElementById('keywordAlert');
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
        
        function checkForKeywords(text) {
            const lowerText = text.toLowerCase();
            for (let keyword of keywords) {
                if (lowerText.includes(keyword.toLowerCase())) {
                    addLog(`🎯 キーワード検出: "${keyword}" in "${text}"`);
                    showKeywordAlert();
                    return true;
                }
            }
            return false;
        }
        
        function startListening() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                addLog('❌ このブラウザは音声認識をサポートしていません');
                alert('このブラウザは音声認識をサポートしていません。Chrome、Edge、Safariをお試しください。');
                return;
            }
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ja-JP';
                
                recognition.onstart = function() {
                    isListening = true;
                    updateStatus(true, true);
                    addLog('✅ 音声認識を開始しました');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        addLog(`📝 認識結果: "${finalTranscript}"`);
                        checkForKeywords(finalTranscript);
                    }
                    
                    if (interimTranscript) {
                        addLog(`🔄 認識中: "${interimTranscript}"`);
                        checkForKeywords(interimTranscript);
                    }
                };
                
                recognition.onerror = function(event) {
                    addLog(`❌ エラー: ${event.error}`);
                    if (event.error === 'not-allowed') {
                        alert('マイクアクセスが拒否されました。ブラウザの設定でマイクアクセスを許可してください。');
                    }
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateStatus(false, false);
                    addLog('⏹️ 音声認識を停止しました');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    
                    // 自動再開（常時リスニング）
                    if (document.getElementById('startBtn').disabled === false) {
                        // 少し待ってから再開
                        setTimeout(() => {
                            if (!isListening) {
                                // startListening();
                            }
                        }, 1000);
                    }
                };
                
                recognition.start();
                
            } catch (error) {
                addLog(`❌ 初期化エラー: ${error.message}`);
                alert('音声認識の初期化に失敗しました。');
            }
        }
        
        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div>ログをクリアしました...</div>';
        }
        
        // 初期化
        updateStatus(false, false);
        addLog('🚀 アプリケーションを初期化しました');
        addLog('💡 HTTPSサイトでマイクアクセスが必要です');
        
        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', function() {
            if (recognition && isListening) {
                recognition.stop();
            }
        });
    </script>
</body>
</html>